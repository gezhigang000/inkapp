name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-sidecar:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            sidecar_name: python-sidecar-aarch64-apple-darwin
            separator: ':'
            noconsole: ''
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            sidecar_name: python-sidecar-x86_64-pc-windows-msvc.exe
            separator: ';'
            noconsole: '--noconsole'
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install -r scripts/requirements.txt pyinstaller

      - name: Build sidecar binary
        shell: bash
        run: |
          cd scripts
          SEP="${{ matrix.separator }}"
          pyinstaller --onefile ${{ matrix.noconsole }} --name python-sidecar \
            --add-data "../prompts${SEP}prompts" \
            --hidden-import requests \
            --hidden-import openpyxl \
            --hidden-import pdfplumber \
            --hidden-import docx \
            --hidden-import pptx \
            --hidden-import PIL \
            --hidden-import oss2 \
            --hidden-import agent_loop \
            --hidden-import agent_prompts \
            --hidden-import reportlab \
            --hidden-import reportlab.lib.pagesizes \
            --hidden-import reportlab.pdfgen \
            --hidden-import pandas \
            --hidden-import numpy \
            --hidden-import matplotlib \
            sidecar_main.py
          mkdir -p ../app/src-tauri/binaries
          cp dist/python-sidecar* ../app/src-tauri/binaries/${{ matrix.sidecar_name }}

      - uses: actions/upload-artifact@v4
        with:
          name: sidecar-${{ matrix.target }}
          path: app/src-tauri/binaries/${{ matrix.sidecar_name }}

  build-tauri:
    needs: build-sidecar
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            args: --target aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            args: --target x86_64-pc-windows-msvc
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Download sidecar
        uses: actions/download-artifact@v4
        with:
          name: sidecar-${{ matrix.target }}
          path: app/src-tauri/binaries/

      - name: Make sidecar executable
        if: runner.os != 'Windows'
        run: chmod +x app/src-tauri/binaries/python-sidecar-*

      - name: Install frontend dependencies
        working-directory: app
        run: npm ci

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: app
          tauriScript: npx tauri
          tagName: ${{ github.ref_name }}
          releaseName: 'Ink ${{ github.ref_name }}'
          releaseBody: 'See the assets to download and install Ink.'
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}
