# AI 日报自动生成系统 — 技术架构与产品化指南

## 一、系统总览

```
┌─────────────────────────────────────────────────────────┐
│                      run.sh 统一入口                      │
│         --mode single (默认) │ --mode batch              │
└────────────┬────────────────────────────┬───────────────┘
             ▼                            ▼
     daily_ai_news.py              batch_generate.py
     (单篇：日报/专题/视频)          (系列文章批量生成)
             │                            │
     ┌───────┴───────┐                    │ (复用同一套核心流程)
     ▼               ▼                    ▼
  Claude CLI      video_analyzer.py   ┌──────────────┐
  (subprocess)    (YouTube 转写)      │  核心生成流程  │
     │               │                │              │
     ▼               ▼                └──────┬───────┘
  ┌────────────────────────────┐             │
  │     Prompt Template 层      │             │
  │  prompt_template.txt        │◄────────────┘
  │  topic_prompt_template.txt  │
  │  video_prompt_template.txt  │
  └─────────────┬──────────────┘
                ▼
  ┌────────────────────────────┐
  │     后处理流水线             │
  │  1. image_processor.py     │──► 图片下载/base64/微信CDN
  │  2. 文章拆分 (>25KB)       │──► PART 标记 → 上/下篇
  │  3. 封面图生成 (Pillow)     │──► 900×383 PNG
  │  4. Footer + 二维码         │──► 追加关注引导
  └─────────────┬──────────────┘
                ▼
  ┌────────────────────────────┐
  │     发布层                  │
  │  微信公众号 API             │
  │  · access_token 认证       │
  │  · 素材上传                │
  │  · 创建草稿 / 直接发布      │
  └────────────────────────────┘
```

---

## 二、核心亮点：为什么生成的文章质量高

### 2.1 Prompt 工程 — 文章深度的根本原因

这套系统的文章质量，**80% 来自 Prompt 设计**。三套模板各有针对性：

| 模板 | 核心策略 | 效果 |
|------|---------|------|
| `prompt_template.txt` | 人设 = "十年工程师+AI爱好者"，要求第一人称叙事，必须有个人判断 | 避免"新闻通稿"感，读起来像技术朋友在聊天 |
| `topic_prompt_template.txt` | 限制搜索次数（3-5次WebSearch + 1-2次WebFetch），聚焦官方文档 | 信息密度高，不灌水 |
| `video_prompt_template.txt` | 要求分析说话者立场偏见，列出"我同意/不同意"的点 | 批判性思维，不是简单搬运 |

**关键 Prompt 技巧：**

1. **反套路指令** — "加入批判性思考：哪些是真突破？哪些是营销包装？" → 生成的文章会出现 "✅ 真突破" vs "⚠️ 需要打折" 的对比分析，这在自媒体中非常稀缺
2. **工具链调度** — Prompt 中明确指定 `WebSearch` 搜真实数据、`WebFetch` 读原始来源，模型不是闭门造车，而是基于实时信息写作
3. **结构变异指令** — "可以尝试不同的开头方式（提问式、故事式、数据式、对比式等）" → 每篇文章的叙事节奏不同
4. **严格输出约束** — "禁止在 HTML 之前或之后输出任何说明性文字" → 避免提取 HTML 时混入废话

### 2.2 内容多样性系统 — 避免千篇一律

```python
pick_daily_variation(today_str)  # MD5(日期) 作为随机种子
├── 12 个话题方向 (AI Agent / LLM推理 / 多模态 / 开源 / ...)
├── 8 种写作视角 (开发者影响 / 架构决策 / 产品创新 / 批判分析 / ...)
├── 10 家公司池 (保证每篇覆盖 3-4 家，至少 1 家核心公司)
├── 5 种文章结构 (速评 / 深度 / 横评 / 趋势 / 实操)
└── 6 套封面配色
```

**设计精妙之处：** 用日期的 MD5 做种子，同一天重跑结果一致（可复现），不同天自动变化（避免重复）。无需数据库。

### 2.3 HTML 排版 — 美观的技术细节

文章的视觉效果好，是因为 Prompt 中**内嵌了一套完整的设计规范**：

**排版参数：**
- 字体栈：`-apple-system, BlinkMacSystemFont, PingFang SC, Microsoft YaHei` — 覆盖 iOS/Android/PC
- 正文：15px / line-height 1.8 / color #333 — 微信端阅读最佳参数
- 最大宽度 780px，两侧 16px padding — 手机端不贴边

**视觉组件（全部通过 Prompt 指导 Claude 生成）：**

| 组件 | 实现方式 | 效果 |
|------|---------|------|
| PART 分隔徽章 | `linear-gradient` 渐变背景 + 圆角胶囊 | 分节清晰，有期刊感 |
| 💬 深度解读卡片 | 左侧 4px 色条 + 浅底背景 + 小标签 | 个人观点与正文视觉分离 |
| 数据指标卡 | Flex 布局 + 胶囊标签 + 彩色底 | 关键数字一目了然 |
| 对比表格 | 彩色表头 + 斑马纹行 | 横评内容结构化呈现 |
| 引用块 | 左侧色条 + 背景色 | 与正文明确区分 |

**关键约束：全部 inline CSS。** 因为微信公众号会剥离 `<style>` 标签和外部样式表，所以每个元素的样式都写在 `style=""` 里。这是 Prompt 中明确要求的。

### 2.4 图片处理链 — 鲁棒的降级策略

```
尝试下载原图 (15s超时, 5MB上限)
    ├─ 成功 → 上传微信CDN / 转base64
    ├─ 失败 → 尝试 DALL-E 生成替代图 (如果配了 OPENAI_API_KEY)
    │         ├─ 成功 → 使用AI生成图
    │         └─ 失败 → 移除该 <img> 标签
    └─ 微信上传失败 → 降级为 base64 内嵌
```

这种多级 fallback 保证了**不管图片源出什么问题，文章都能正常发布**，不会因为一张图挂了导致整篇废掉。

### 2.5 封面图生成 — Pillow 程序化设计

不依赖外部设计工具，纯代码生成 900×383 封面图：

- 6 套配色方案轮换（白底蓝/灰底蓝/米底橙/绿底绿/紫底紫/暖底橙）
- 背景装饰元素（点阵、圆弧、对角线、六边形、网络节点图）用日期种子随机生成
- 标题自动换行（逐字测量宽度，超限截断加 "..."）
- 系统字体自动探测（STHeiti → Hiragino → PingFang → Songti）

---

## 三、可优化方向

### 3.1 内容质量层

| 方向 | 现状 | 优化建议 |
|------|------|---------|
| **历史去重** | 仅靠日期种子避免重复，无内容级去重 | 维护已发布文章的标题/摘要索引（SQLite 或 JSON），Prompt 中注入"近7天已覆盖话题"，避免重复选题 |
| **事实校验** | 依赖 Claude 的 WebSearch 结果，无二次验证 | 增加后处理步骤：提取文章中的数字/日期/公司名，调用搜索 API 交叉验证关键事实 |
| **读者反馈闭环** | 无 | 通过微信 API 拉取文章阅读量/点赞/评论数据，分析哪类话题/结构/标题更受欢迎，反哺 Prompt 调优 |
| **多语言源** | 主要搜英文源 | 增加对 arXiv 论文、GitHub trending、Hacker News 的结构化抓取，丰富信息源 |

### 3.2 工程健壮性

| 方向 | 现状 | 优化建议 |
|------|------|---------|
| **重试机制** | Claude 超时直接失败，无重试 | 添加指数退避重试（最多 2 次），对图片下载也加重试 |
| **日志与监控** | 仅 stdout/stderr 输出到文件 | 结构化日志（JSON 格式），记录每步耗时、token 用量、成功/失败状态；接入企业微信/钉钉告警 |
| **图片缓存** | 每次重新下载 | 本地图片缓存（URL→文件映射），避免重复下载相同图片 |
| **配置管理** | 明文 config.env | 敏感信息（APP_SECRET、API_KEY）迁移到系统 keychain 或环境变量 |
| **测试覆盖** | 无测试 | 核心函数（HTML 提取、文章拆分、图片处理）增加单元测试 |

### 3.3 产品体验层

| 方向 | 现状 | 优化建议 |
|------|------|---------|
| **可视化预览** | 只生成 HTML 文件 | 增加本地预览服务器（`python -m http.server`），生成后自动打开浏览器预览 |
| **Web 管理后台** | 纯命令行操作 | 轻量 Web UI（Flask/FastAPI），支持主题选择、预览、一键发布 |
| **定时策略** | 固定每天 6:00 | 支持多时段发布（早报/晚报），可按日期配置发布计划 |
| **多公众号支持** | 单号 | 配置文件支持多套微信凭证，按公众号分发不同内容 |

---

## 四、国产模型替代方案

### 4.1 核心挑战

当前系统通过 `subprocess` 调用 Claude CLI，依赖两个关键能力：

1. **实时搜索** — Claude 的 `WebSearch` + `WebFetch` 工具，用于获取最新 AI 新闻
2. **长文生成** — 生成 1500-3000 字结构化 HTML，需要强指令跟随能力

国产模型替代需要同时解决这两个问题。

### 4.2 推荐方案：DeepSeek + 搜索增强

**首选：DeepSeek-V3 / DeepSeek-R1**

| 维度 | 评估 |
|------|------|
| 中文写作质量 | 优秀，中文语料训练充分，文风自然 |
| 指令跟随 | V3 的 HTML 结构化输出能力强 |
| 上下文窗口 | 128K，足够处理长文+搜索结果 |
| 成本 | API 价格约 Claude 的 1/10 |
| 搜索能力 | **无内置搜索，需自行实现** |

**改造方案：**

```
┌──────────────────────────────────────────────┐
│            改造后的架构                        │
│                                              │
│  1. 搜索层（替代 WebSearch/WebFetch）          │
│     ├─ SerpAPI / 搜狗搜索 API → 获取新闻列表   │
│     ├─ Jina Reader API → 网页正文提取          │
│     └─ 组装为结构化上下文                      │
│                                              │
│  2. 生成层（替代 Claude CLI）                  │
│     ├─ DeepSeek API (HTTP 调用，替代 subprocess)│
│     ├─ Prompt 基本复用，微调格式指令            │
│     └─ 流式输出，降低超时风险                   │
│                                              │
│  3. 后处理层（完全复用）                        │
│     ├─ image_processor.py 不变               │
│     ├─ 封面图生成不变                          │
│     └─ 微信发布流程不变                        │
└──────────────────────────────────────────────┘
```

**代码改造要点：**

```python
# 现有方式：Claude CLI subprocess
result = subprocess.run(
    ["claude", "-p", prompt, "--allowedTools", "WebSearch,WebFetch"],
    capture_output=True, timeout=600
)

# 改造后：先搜索，再调 DeepSeek API
import requests

# Step 1: 搜索层
def search_ai_news(companies, topic):
    """用搜索 API 获取最新新闻"""
    results = []
    for company in companies:
        query = f"{company} AI latest news {topic}"
        # 调用 SerpAPI / Bing Search API / 搜狗搜索
        resp = requests.get("https://serpapi.com/search", params={...})
        results.extend(parse_search_results(resp.json()))

    # 用 Jina Reader 提取正文
    for r in results[:5]:  # 取 Top 5 深度阅读
        r["content"] = fetch_page_content(r["url"])
    return results

# Step 2: 组装 Prompt（将搜索结果嵌入上下文）
def build_prompt_with_context(template, search_results):
    context = "\n\n".join([
        f"来源: {r['title']} ({r['url']})\n{r['content'][:2000]}"
        for r in search_results
    ])
    return template.replace("{{SEARCH_CONTEXT}}", context)

# Step 3: 调用 DeepSeek API
def generate_with_deepseek(prompt):
    resp = requests.post(
        "https://api.deepseek.com/v1/chat/completions",
        headers={"Authorization": f"Bearer {DEEPSEEK_API_KEY}"},
        json={
            "model": "deepseek-chat",  # V3
            "messages": [{"role": "user", "content": prompt}],
            "max_tokens": 8192,
            "temperature": 0.7,
            "stream": True  # 流式输出避免超时
        },
        stream=True
    )
    # 流式读取拼接完整输出
    ...
```

### 4.3 备选国产模型对比

| 模型 | 中文写作 | HTML生成 | 上下文 | 搜索集成 | API价格 | 推荐度 |
|------|---------|---------|--------|---------|---------|--------|
| **DeepSeek-V3** | ★★★★★ | ★★★★☆ | 128K | 需自建 | 极低 | **首选** |
| **Qwen-Max** (通义千问) | ★★★★★ | ★★★★☆ | 128K | 有联网搜索插件 | 中等 | **次选** |
| **GLM-4** (智谱) | ★★★★☆ | ★★★☆☆ | 128K | 有 Web 搜索工具 | 中等 | 可选 |
| **Moonshot (Kimi)** | ★★★★☆ | ★★★☆☆ | 200K | 内置联网 | 较高 | 长文优势 |
| **Doubao (豆包)** | ★★★★☆ | ★★★☆☆ | 128K | 有搜索插件 | 低 | 性价比方案 |

**如果不想自建搜索层：** 选 **Qwen-Max** 或 **GLM-4**，它们的 API 支持搜索工具调用（类似 Claude 的 WebSearch），改造量最小。

**如果追求极致性价比：** 选 **DeepSeek-V3**，自建搜索层（SerpAPI 月费 ~$50），总成本远低于 Claude。

### 4.4 Prompt 迁移注意事项

国产模型的 Prompt 需要微调：

```diff
  # 通用调整
- 优先选择官方博客、技术文档的配图
+ 请在文章中插入 2-4 张配图，用 <img src="搜索到的图片URL"> 格式
+ （图片URL请从搜索结果中提取，确保是 https 开头的有效链接）

  # DeepSeek 特有
+ 请严格按照以下 HTML 模板格式输出，不要输出 markdown：
+ 开头必须是 <section style="...">, 结尾必须是 </section>
+ （DeepSeek 默认倾向输出 Markdown，需要更强的格式约束）

  # 搜索结果注入
- 用 WebSearch 搜索 {companies} 在过去 24 小时的 AI 相关动态
+ 以下是最新搜索到的 AI 新闻（请基于这些内容撰写）：
+ {{SEARCH_CONTEXT}}
```

---

## 五、产品化指南

### 5.1 从脚本到产品的路线图

```
Phase 1: 稳定化（当前 → 2周）
━━━━━━━━━━━━━━━━━━━━━━━━━━
  □ 添加重试机制和结构化日志
  □ 配置迁移到环境变量 / .env（gitignore）
  □ 核心函数单元测试
  □ 发布结果通知（企业微信/钉钉机器人）

Phase 2: 可视化（2周 → 6周）
━━━━━━━━━━━━━━━━━━━━━━━━━━
  □ Web 管理后台（FastAPI + 简单前端）
    ├─ 主题配置界面（替代改代码）
    ├─ 文章预览（微信样式模拟）
    ├─ 一键发布 / 定时发布
    └─ 历史文章列表 + 数据看板
  □ 多公众号支持
  □ 自定义 Prompt 模板（Web 编辑器）

Phase 3: 智能化（6周 → 12周）
━━━━━━━━━━━━━━━━━━━━━━━━━━
  □ 阅读数据回流分析（哪类选题效果好）
  □ A/B 标题测试（同文章生成多个标题，选效果最好的）
  □ 自动选题系统（基于热点 + 历史表现）
  □ 多渠道分发（知乎/头条/小红书 格式适配）

Phase 4: SaaS 化（12周+）
━━━━━━━━━━━━━━━━━━━━━━━━━━
  □ 多租户架构（不同用户管理各自公众号）
  □ 计费系统（按文章篇数或 token 用量）
  □ 模板市场（用户可分享/购买 Prompt 模板）
  □ 插件系统（自定义数据源、发布渠道）
```

### 5.2 技术选型建议（产品化阶段）

| 层次 | 当前 | 产品化建议 |
|------|------|-----------|
| 运行环境 | macOS launchd | Docker 容器 + 云服务器（阿里云/腾讯云） |
| 任务调度 | launchd plist | Celery + Redis，或轻量级 APScheduler |
| 数据存储 | 文件系统 | PostgreSQL（文章元数据）+ OSS（图片/HTML） |
| 后端框架 | 无（纯脚本） | FastAPI（异步，适合 AI 生成的长耗时请求） |
| 前端 | 无 | React / Vue + Tailwind（管理后台） |
| AI 调用 | Claude CLI subprocess | HTTP API 直调（DeepSeek/Qwen），支持流式 |
| 监控 | 无 | Sentry（错误追踪）+ Prometheus（指标） |

### 5.3 成本估算（单公众号日更）

| 项目 | Claude 方案（当前） | DeepSeek 方案 |
|------|-------------------|--------------|
| AI 生成 | ~$0.50/篇（Opus） | ~$0.03/篇（V3） |
| 搜索 API | 内置（$0） | SerpAPI ~$0.01/次 × 10 = $0.10 |
| 图片生成（可选） | DALL-E ~$0.04/张 | 可用免费开源模型 |
| 服务器 | 本地 Mac（$0） | 云服务器 ~$50/月 |
| **日均成本** | **~$0.50** | **~$0.15** |
| **月均成本** | **~$15** | **~$5 + 服务器** |

### 5.4 合规注意事项

- **AI 生成内容标注**：根据国内《生成式人工智能服务管理暂行办法》，AI 生成的内容需要进行标识
- **信息源审核**：自动抓取的新闻内容需确保来源可靠，避免传播不实信息
- **公众号运营规范**：微信对高频自动发布有限制，建议保持草稿模式人工审核后发布
- **数据安全**：微信 APP_SECRET 等凭证不要提交到代码仓库

---

## 六、文件清单速查

| 文件 | 职责 | 行数 |
|------|------|------|
| `run.sh` | 统一入口，参数路由 | ~57 |
| `daily_ai_news.py` | 核心生成流程（单篇） | ~800 |
| `batch_generate.py` | 批量生成流程 | ~190 |
| `image_processor.py` | 图片下载/上传/base64/AI生成 | ~250 |
| `video_analyzer.py` | YouTube 视频转写与分析 | ~300 |
| `prompt_template.txt` | 日报 Prompt（人设+格式+搜索指令） | ~150 |
| `topic_prompt_template.txt` | 专题研究 Prompt | ~120 |
| `video_prompt_template.txt` | 视频分析 Prompt | ~130 |
| `config.env` | 配置（微信凭证/输出目录/发布模式） | ~20 |
| `com.weixin.aidaily.plist` | macOS 定时任务配置 | ~30 |
| `pylib/` | 内置 Pillow 库（封面图生成依赖） | — |
